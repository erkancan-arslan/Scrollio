# Scrollio - Database Schema

**Last Updated:** December 2025
**Database:** PostgreSQL 15+ (via Supabase)
**Status:** Active

This document defines the complete database schema for Scrollio, including tables, relationships, indexes, and Row Level Security (RLS) policies.

---

## Schema Overview

```
users (Supabase Auth)
    ↓
profiles (user metadata)
    ↓
user_progress → videos → topics
    ↓              ↓
quizzes ←──────────┘
    ↓
quiz_attempts
    ↓
achievements

parental_controls
    ↓
child_profiles

ai_characters → videos

content_reports
```

---

## Tables

### 1. users (Managed by Supabase Auth)

**Purpose:** Authentication and identity (managed by Supabase Auth)

**Note:** This table is automatically managed by Supabase. Do not modify directly.

```sql
-- Auto-generated by Supabase Auth
CREATE TABLE auth.users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE,
  encrypted_password TEXT,
  email_confirmed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  -- Other Supabase Auth fields...
);
```

**Fields:**
- `id` (UUID, PK): Unique user identifier
- `email` (TEXT): User email address
- `created_at` (TIMESTAMPTZ): Account creation timestamp

**RLS:** Managed by Supabase Auth

---

### 2. profiles

**Purpose:** Extended user profile information and gamification data

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT,
  avatar_url TEXT,
  age_group TEXT CHECK (age_group IN ('7-12', '13-17', '18-24', '25-34', '35-44', '45+')),
  level INTEGER DEFAULT 1,
  xp INTEGER DEFAULT 0,
  total_videos_watched INTEGER DEFAULT 0,
  total_quizzes_completed INTEGER DEFAULT 0,
  average_quiz_score DECIMAL(5,2) DEFAULT 0,
  streak_days INTEGER DEFAULT 0,
  last_active_date DATE,
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_profiles_level ON profiles(level DESC);
CREATE INDEX idx_profiles_xp ON profiles(xp DESC);
CREATE INDEX idx_profiles_last_active ON profiles(last_active_date DESC);
```

**Fields:**
- `id` (UUID, PK, FK → users): User identifier
- `display_name` (TEXT): User's display name
- `avatar_url` (TEXT): URL to user avatar in Supabase Storage or S3
- `age_group` (TEXT): User age category for content filtering
- `level` (INTEGER): Gamification level (calculated from XP)
- `xp` (INTEGER): Experience points
- `total_videos_watched` (INTEGER): Count of completed videos
- `total_quizzes_completed` (INTEGER): Count of completed quizzes
- `average_quiz_score` (DECIMAL): Average quiz score percentage
- `streak_days` (INTEGER): Consecutive days of activity
- `last_active_date` (DATE): Last date user was active
- `preferences` (JSONB): User preferences (theme, notifications, etc.)

**RLS Policy:**
- Users can read and update their own profile
- Public read access to display_name, avatar_url, level, xp (for leaderboards)

```sql
-- RLS Policies
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Users can view their own profile
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

-- Users can update their own profile
CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);

-- Public can view limited profile info (leaderboards)
CREATE POLICY "Public leaderboard access"
  ON profiles FOR SELECT
  USING (true); -- Limit columns in app layer (display_name, avatar_url, level, xp)
```

---

### 3. topics

**Purpose:** Educational topics/categories for content organization

```sql
CREATE TABLE topics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT UNIQUE NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  icon_url TEXT,
  category TEXT CHECK (category IN ('science', 'technology', 'finance', 'arts', 'history', 'languages', 'health', 'other')),
  age_appropriate_min INTEGER DEFAULT 7,
  age_appropriate_max INTEGER DEFAULT 99,
  video_count INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_topics_category ON topics(category);
CREATE INDEX idx_topics_active ON topics(is_active) WHERE is_active = true;
CREATE INDEX idx_topics_slug ON topics(slug);
```

**Fields:**
- `id` (UUID, PK): Unique topic identifier
- `name` (TEXT): Topic display name (e.g., "Software Engineering")
- `slug` (TEXT): URL-friendly name (e.g., "software-engineering")
- `description` (TEXT): Topic description
- `icon_url` (TEXT): Topic icon image URL
- `category` (TEXT): Broad category
- `age_appropriate_min/max` (INTEGER): Age range for content filtering
- `video_count` (INTEGER): Cached count of videos in this topic
- `is_active` (BOOLEAN): Whether topic is available

**RLS Policy:**
- Public read access
- Only admins can create/update/delete

```sql
ALTER TABLE topics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public can view active topics"
  ON topics FOR SELECT
  USING (is_active = true);
```

---

### 4. videos

**Purpose:** Educational video content

```sql
CREATE TABLE videos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  topic_id UUID REFERENCES topics(id) ON DELETE SET NULL,
  ai_character_id UUID REFERENCES ai_characters(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  description TEXT,
  url TEXT NOT NULL, -- CloudFront URL
  thumbnail_url TEXT,
  duration INTEGER NOT NULL, -- Duration in seconds
  creator_type TEXT CHECK (creator_type IN ('ai', 'expert', 'community')),
  creator_id UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- For expert/community creators
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  difficulty_level TEXT CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
  age_appropriate_min INTEGER DEFAULT 7,
  age_appropriate_max INTEGER DEFAULT 99,
  is_published BOOLEAN DEFAULT false,
  moderation_status TEXT CHECK (moderation_status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending',
  metadata JSONB DEFAULT '{}'::jsonb, -- Video resolution, codec, file size, etc.
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_videos_topic ON videos(topic_id);
CREATE INDEX idx_videos_published ON videos(is_published) WHERE is_published = true;
CREATE INDEX idx_videos_creator_type ON videos(creator_type);
CREATE INDEX idx_videos_moderation ON videos(moderation_status);
CREATE INDEX idx_videos_created_at ON videos(created_at DESC);
```

**Fields:**
- `id` (UUID, PK): Unique video identifier
- `topic_id` (UUID, FK → topics): Associated topic
- `ai_character_id` (UUID, FK → ai_characters): AI narrator (if AI-generated)
- `title` (TEXT): Video title
- `description` (TEXT): Video description
- `url` (TEXT): CloudFront URL for video playback
- `thumbnail_url` (TEXT): Video thumbnail URL
- `duration` (INTEGER): Video length in seconds
- `creator_type` (TEXT): Type of creator (ai, expert, community)
- `creator_id` (UUID, FK → users): Expert/community creator
- `view_count` (INTEGER): Total views
- `like_count` (INTEGER): Total likes
- `difficulty_level` (TEXT): Content difficulty
- `age_appropriate_min/max` (INTEGER): Age filtering
- `is_published` (BOOLEAN): Whether video is live
- `moderation_status` (TEXT): Content moderation status
- `metadata` (JSONB): Additional video metadata

**RLS Policy:**
- Public read access for published, approved videos
- Only admins/creators can create/update

```sql
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public can view published videos"
  ON videos FOR SELECT
  USING (is_published = true AND moderation_status = 'approved');

CREATE POLICY "Creators can view own videos"
  ON videos FOR SELECT
  USING (auth.uid() = creator_id);
```

---

### 5. quizzes

**Purpose:** Quiz questions associated with videos

```sql
CREATE TABLE quizzes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  question TEXT NOT NULL,
  question_type TEXT CHECK (question_type IN ('multiple_choice', 'true_false', 'fill_blank')) DEFAULT 'multiple_choice',
  options JSONB NOT NULL, -- [{ "id": "a", "text": "Option A" }, ...]
  correct_answer TEXT NOT NULL, -- ID of correct option
  explanation TEXT,
  difficulty_level TEXT CHECK (difficulty_level IN ('easy', 'medium', 'hard')) DEFAULT 'medium',
  xp_reward INTEGER DEFAULT 10,
  order_index INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_quizzes_video ON quizzes(video_id);
CREATE INDEX idx_quizzes_order ON quizzes(video_id, order_index);
```

**Fields:**
- `id` (UUID, PK): Unique quiz identifier
- `video_id` (UUID, FK → videos): Associated video
- `question` (TEXT): Quiz question text
- `question_type` (TEXT): Type of question
- `options` (JSONB): Answer options (JSON array)
- `correct_answer` (TEXT): ID of correct option
- `explanation` (TEXT): Explanation shown after answer
- `difficulty_level` (TEXT): Question difficulty
- `xp_reward` (INTEGER): XP earned for correct answer
- `order_index` (INTEGER): Order in quiz sequence

**RLS Policy:**
- Public read access for quizzes of published videos

```sql
ALTER TABLE quizzes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public can view quizzes"
  ON quizzes FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM videos
      WHERE videos.id = quizzes.video_id
      AND videos.is_published = true
      AND videos.moderation_status = 'approved'
    )
  );
```

---

### 6. user_progress

**Purpose:** Track user's video watching progress

```sql
CREATE TABLE user_progress (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  watched_duration INTEGER DEFAULT 0, -- Seconds watched
  completed BOOLEAN DEFAULT false,
  last_watched_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, video_id)
);

-- Indexes
CREATE INDEX idx_user_progress_user ON user_progress(user_id);
CREATE INDEX idx_user_progress_video ON user_progress(video_id);
CREATE INDEX idx_user_progress_completed ON user_progress(user_id, completed);
```

**Fields:**
- `id` (UUID, PK): Unique progress entry
- `user_id` (UUID, FK → users): User
- `video_id` (UUID, FK → videos): Video
- `watched_duration` (INTEGER): Seconds watched
- `completed` (BOOLEAN): Whether user completed video
- `last_watched_at` (TIMESTAMPTZ): Last watch time

**RLS Policy:**
- Users can only access their own progress

```sql
ALTER TABLE user_progress ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own progress"
  ON user_progress FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own progress"
  ON user_progress FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own progress"
  ON user_progress FOR UPDATE
  USING (auth.uid() = user_id);
```

---

### 7. quiz_attempts

**Purpose:** Track user's quiz attempts and scores

```sql
CREATE TABLE quiz_attempts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE,
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  answer TEXT NOT NULL,
  is_correct BOOLEAN NOT NULL,
  xp_earned INTEGER DEFAULT 0,
  time_taken INTEGER, -- Seconds to answer
  attempt_number INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_quiz_attempts_user ON quiz_attempts(user_id);
CREATE INDEX idx_quiz_attempts_quiz ON quiz_attempts(quiz_id);
CREATE INDEX idx_quiz_attempts_video ON quiz_attempts(video_id);
CREATE INDEX idx_quiz_attempts_created_at ON quiz_attempts(created_at DESC);
```

**Fields:**
- `id` (UUID, PK): Unique attempt identifier
- `user_id` (UUID, FK → users): User
- `quiz_id` (UUID, FK → quizzes): Quiz question
- `video_id` (UUID, FK → videos): Associated video
- `answer` (TEXT): User's answer (option ID)
- `is_correct` (BOOLEAN): Whether answer was correct
- `xp_earned` (INTEGER): XP earned from this attempt
- `time_taken` (INTEGER): Seconds to answer
- `attempt_number` (INTEGER): Attempt count for this quiz

**RLS Policy:**
- Users can only access their own attempts

```sql
ALTER TABLE quiz_attempts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own attempts"
  ON quiz_attempts FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own attempts"
  ON quiz_attempts FOR INSERT
  WITH CHECK (auth.uid() = user_id);
```

---

### 8. achievements

**Purpose:** Gamification badges and achievements

```sql
CREATE TABLE achievements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  achievement_type TEXT NOT NULL, -- 'first_video', 'streak_7_days', 'level_10', etc.
  title TEXT NOT NULL,
  description TEXT,
  icon_url TEXT,
  xp_reward INTEGER DEFAULT 0,
  unlocked_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, achievement_type)
);

-- Indexes
CREATE INDEX idx_achievements_user ON achievements(user_id);
CREATE INDEX idx_achievements_type ON achievements(achievement_type);
```

**Fields:**
- `id` (UUID, PK): Unique achievement identifier
- `user_id` (UUID, FK → users): User
- `achievement_type` (TEXT): Achievement identifier
- `title` (TEXT): Achievement title
- `description` (TEXT): Achievement description
- `icon_url` (TEXT): Badge icon URL
- `xp_reward` (INTEGER): XP earned from achievement
- `unlocked_at` (TIMESTAMPTZ): When unlocked

**RLS Policy:**
- Users can view their own achievements
- Public can view achievement counts (leaderboards)

```sql
ALTER TABLE achievements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own achievements"
  ON achievements FOR SELECT
  USING (auth.uid() = user_id);
```

---

### 9. parental_controls

**Purpose:** Parent-child relationship and control settings

```sql
CREATE TABLE parental_controls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  parent_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  child_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  daily_time_limit INTEGER DEFAULT 60, -- Minutes per day
  allowed_topics UUID[] DEFAULT ARRAY[]::UUID[], -- Array of topic IDs
  blocked_topics UUID[] DEFAULT ARRAY[]::UUID[],
  content_filter_level TEXT CHECK (content_filter_level IN ('strict', 'moderate', 'relaxed')) DEFAULT 'moderate',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(parent_id, child_id)
);

-- Indexes
CREATE INDEX idx_parental_controls_parent ON parental_controls(parent_id);
CREATE INDEX idx_parental_controls_child ON parental_controls(child_id);
```

**Fields:**
- `id` (UUID, PK): Unique control entry
- `parent_id` (UUID, FK → users): Parent user
- `child_id` (UUID, FK → users): Child user
- `daily_time_limit` (INTEGER): Max minutes per day
- `allowed_topics` (UUID[]): Whitelisted topics
- `blocked_topics` (UUID[]): Blacklisted topics
- `content_filter_level` (TEXT): Filtering strictness
- `is_active` (BOOLEAN): Whether controls are active

**RLS Policy:**
- Parents can manage their children's controls
- Children cannot modify controls

```sql
ALTER TABLE parental_controls ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Parents can manage child controls"
  ON parental_controls FOR ALL
  USING (auth.uid() = parent_id);

CREATE POLICY "Children can view their controls"
  ON parental_controls FOR SELECT
  USING (auth.uid() = child_id);
```

---

### 10. ai_characters

**Purpose:** AI narrator characters for videos

```sql
CREATE TABLE ai_characters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT UNIQUE NOT NULL,
  personality TEXT,
  voice_id TEXT, -- ElevenLabs voice ID
  avatar_url TEXT,
  topic_specialization UUID REFERENCES topics(id) ON DELETE SET NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  video_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_ai_characters_topic ON ai_characters(topic_specialization);
CREATE INDEX idx_ai_characters_active ON ai_characters(is_active) WHERE is_active = true;
```

**Fields:**
- `id` (UUID, PK): Unique character identifier
- `name` (TEXT): Character name
- `personality` (TEXT): Character personality description
- `voice_id` (TEXT): ElevenLabs voice identifier
- `avatar_url` (TEXT): Character avatar image
- `topic_specialization` (UUID, FK → topics): Primary topic
- `description` (TEXT): Character bio
- `is_active` (BOOLEAN): Whether character is active
- `video_count` (INTEGER): Cached video count

**RLS Policy:**
- Public read access for active characters

```sql
ALTER TABLE ai_characters ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public can view active characters"
  ON ai_characters FOR SELECT
  USING (is_active = true);
```

---

### 11. content_reports

**Purpose:** User-reported inappropriate content

```sql
CREATE TABLE content_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  reporter_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
  reason TEXT CHECK (reason IN ('inappropriate', 'inaccurate', 'offensive', 'spam', 'other')),
  details TEXT,
  status TEXT CHECK (status IN ('pending', 'reviewed', 'actioned', 'dismissed')) DEFAULT 'pending',
  reviewed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  reviewed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_content_reports_video ON content_reports(video_id);
CREATE INDEX idx_content_reports_status ON content_reports(status);
CREATE INDEX idx_content_reports_created_at ON content_reports(created_at DESC);
```

**Fields:**
- `id` (UUID, PK): Unique report identifier
- `reporter_id` (UUID, FK → users): User who reported
- `video_id` (UUID, FK → videos): Reported video
- `reason` (TEXT): Report reason category
- `details` (TEXT): Additional details
- `status` (TEXT): Moderation status
- `reviewed_by` (UUID, FK → users): Admin who reviewed
- `reviewed_at` (TIMESTAMPTZ): Review timestamp

**RLS Policy:**
- Users can submit reports
- Only admins can view/update reports

```sql
ALTER TABLE content_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can submit reports"
  ON content_reports FOR INSERT
  WITH CHECK (auth.uid() = reporter_id);
```

---

## Relationships

```
users (auth) 1:1 profiles
profiles 1:N user_progress
profiles 1:N quiz_attempts
profiles 1:N achievements
profiles 1:N parental_controls (as parent)
profiles 1:N parental_controls (as child)

topics 1:N videos
topics 1:N ai_characters

videos 1:N quizzes
videos 1:N user_progress
videos 1:N quiz_attempts
videos 1:N content_reports
videos N:1 ai_characters

quizzes 1:N quiz_attempts
```

---

## Triggers & Functions

### Update profile stats on quiz completion

```sql
CREATE OR REPLACE FUNCTION update_profile_stats()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE profiles
  SET
    total_quizzes_completed = total_quizzes_completed + 1,
    xp = xp + NEW.xp_earned,
    average_quiz_score = (
      SELECT AVG(CASE WHEN is_correct THEN 100 ELSE 0 END)
      FROM quiz_attempts
      WHERE user_id = NEW.user_id
    ),
    level = FLOOR(xp / 100) + 1 -- Level up every 100 XP
  WHERE id = NEW.user_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_profile_stats
AFTER INSERT ON quiz_attempts
FOR EACH ROW
EXECUTE FUNCTION update_profile_stats();
```

### Update video count on video creation

```sql
CREATE OR REPLACE FUNCTION update_video_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE topics
    SET video_count = video_count + 1
    WHERE id = NEW.topic_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE topics
    SET video_count = video_count - 1
    WHERE id = OLD.topic_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_video_count
AFTER INSERT OR DELETE ON videos
FOR EACH ROW
EXECUTE FUNCTION update_video_count();
```

---

## Sample Queries

### Get personalized video feed for user

```sql
SELECT v.*
FROM videos v
JOIN topics t ON v.topic_id = t.id
WHERE v.is_published = true
  AND v.moderation_status = 'approved'
  AND v.age_appropriate_min <= (SELECT SUBSTRING(age_group FROM 1 FOR 2)::INTEGER FROM profiles WHERE id = $user_id)
  AND v.age_appropriate_max >= (SELECT SUBSTRING(age_group FROM 1 FOR 2)::INTEGER FROM profiles WHERE id = $user_id)
  AND NOT EXISTS (
    SELECT 1 FROM user_progress
    WHERE user_id = $user_id
    AND video_id = v.id
    AND completed = true
  )
ORDER BY v.created_at DESC
LIMIT 20;
```

### Get user's quiz performance

```sql
SELECT
  COUNT(*) as total_attempts,
  SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) as correct_answers,
  ROUND(AVG(CASE WHEN is_correct THEN 100 ELSE 0 END), 2) as accuracy_percentage,
  SUM(xp_earned) as total_xp
FROM quiz_attempts
WHERE user_id = $user_id;
```

### Leaderboard (top users by XP)

```sql
SELECT
  display_name,
  avatar_url,
  level,
  xp,
  total_videos_watched,
  total_quizzes_completed
FROM profiles
ORDER BY xp DESC, level DESC
LIMIT 100;
```

---

## Migrations

All schema changes should be managed via Supabase migrations:

```bash
# Create new migration
supabase migration new add_new_feature

# Apply migrations locally
supabase db push

# Reset database (dev only)
supabase db reset
```

Store migrations in `code/supabase/migrations/`

---

## Security Notes

**Row Level Security (RLS):**
- ALL tables have RLS enabled
- Users can only access their own data (progress, attempts, achievements)
- Public data (videos, topics, quizzes) is read-only for all users
- Admins bypass RLS via service role key (use sparingly)

**Full RLS policy documentation:** See `brain/06-security/rls-policies.md`

---

## Performance Considerations

**Indexes:**
- All foreign keys have indexes
- Frequently queried columns have indexes
- Composite indexes for common query patterns

**Optimization:**
- Use `video_count`, `total_videos_watched` caching to avoid expensive counts
- Use triggers to keep cached counts updated
- Partition large tables if needed (e.g., `quiz_attempts` by date)

---

## Future Enhancements

**Planned Tables:**
- `user_follows` - Social following (Phase 3)
- `video_likes` - Like tracking (Phase 2)
- `comments` - Video comments (Phase 3)
- `playlists` - Custom playlists (Phase 3)
- `notifications` - In-app notifications (Phase 2)

---

**For more details:**
- **RLS Policies:** `brain/06-security/rls-policies.md`
- **API Documentation:** `brain/03-api/supabase/database-api.md`
- **Migrations:** `code/supabase/migrations/`
